#!/bin/bash

# YouTube Transcript Viewer - Quick Launch Script
# Usage: yt

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ðŸš€ Launching YouTube Transcript Viewer...${NC}"

# Virtual environment directory
VENV_DIR="venv"

# Check if virtual environment exists
if [ ! -d "$VENV_DIR" ]; then
    echo -e "${BLUE}ðŸ“¦ Setting up for first time...${NC}"
    python3 -m venv "$VENV_DIR"
    source "$VENV_DIR/bin/activate"
    pip install --upgrade pip > /dev/null 2>&1
    pip install -r requirements.txt > /dev/null 2>&1
    echo -e "${GREEN}âœ… Setup complete!${NC}"
else
    source "$VENV_DIR/bin/activate"
fi

# Configure Streamlit
export STREAMLIT_SERVER_PORT=8501
export STREAMLIT_SERVER_HEADLESS=true
export STREAMLIT_BROWSER_GATHER_USAGE_STATS=false

# Launch Streamlit app silently
streamlit run app.py --server.port=$STREAMLIT_SERVER_PORT --browser.gatherUsageStats=false > /dev/null 2>&1 &

# Store the PID
echo $! > .streamlit.pid

echo -e "${GREEN}âœ… App is running!${NC}"
echo -e "${BLUE}ðŸŒ Opening in browser: http://localhost:8501${NC}"
echo -e "${BLUE}ðŸ’¡ Press Ctrl+C or run 'yt stop' to close${NC}"

# Open in default browser
sleep 2
if [[ "$OSTYPE" == "darwin"* ]]; then
    open "http://localhost:8501"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    xdg-open "http://localhost:8501"
fi

# Keep script running to capture Ctrl+C
trap cleanup INT

cleanup() {
    echo -e "\n${BLUE}ðŸ›‘ Stopping app...${NC}"
    if [ -f .streamlit.pid ]; then
        kill $(cat .streamlit.pid) 2>/dev/null
        rm .streamlit.pid
    fi
    pkill -f "streamlit run app.py" 2>/dev/null
    echo -e "${GREEN}âœ… App stopped${NC}"
    exit 0
}

# Wait for user interrupt
echo ""
read -p "Press Enter to stop the app..."
cleanup
